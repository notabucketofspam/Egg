<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="utf-8" />
  <title></title>
</head>
<body>
<h1>EggMicroV4R0</h1>
<hr />
<form id="submission-form" onsubmit="formSubmitHandler(this)" method="POST">
  <div>
    <label for="territory-select">Territory</label>
    <select id="territory-select" name="territorySelect">
      <option value='{"territory": "none", "industry": "none"}' style="background-color: unset;" selected>
        ---
      </option>
      <option value='{"territory": "Alpha", "industry": "Brown"}' style="background-color: unset;">
        Alpha
      </option>
      <option value='{"territory": "Bravo", "industry": "Black"}' style="background-color: unset;">
        Bravo
      </option>
      <option value='{"territory": "Charlie", "industry": "Teal"}' style="background-color: unset;">
        Charlie
      </option>
    </select>
  </div>
  <div>
    <label for="win-lose">Won the match</label>
    <input id="win-lose" name="winLose" type="checkbox" />
  </div>
  <div>
    <label for="stock-count-start">Stock count start</label>
    <input id="stock-count-start" name="stockCountStart" class="stock-counter"
      type="number" min="0" max="10" value="0" />
  </div>
  <div>
    <label for="stock-count-end">Stock count end</label>
    <input id="stock-count-end" name="stockCountEnd" class="stock-counter"
      type="number" min="0" max="10" value="0" />
  </div>
  <div>
    <input id="submit-input" type="submit" value="Plug it in, coach" />
  </div>
</form>
<input id="do-form-error-check" type="checkbox" checked />
<label for="do-form-error-check">Error check</label>
<hr />
<div id="submit-start-message" style="display: none;">
  Form submitted, please wait...
</div>
<div id="submit-complete-message" style="display: none;">
  Your taxes have been filed
  <br />
  <input type="button" onclick="formUndoHandler()" value="Undo" />
</div>
<div id="undo-message" style="display: none;">
  Don't mess it up this time, pal
  <br />
  Gaffe counter: <span id="gaffe-counter"></span>
</div>
<div id="form-error-check-message-area" style="display: none;">
  <div id="invalid-territory-select-message" style="display: none;">
    Pick a territory bruh
  </div>
  <div id="invalid-win-lose-message" style="display: none;">
    "Yes officer I won the game with zero stocks left I swear"
  </div>
  <div id="invalid-stock-count-start-message" style="display: none;">
    If you started with zero stocks that means you were dead #wakemeupinside
  </div>
  <div id="invalid-stock-count-end-message" style="display: none;">
    You can't end up with more stocks than you started with. That's called theft and it's very illegal.
  </div>
</div>
<div id="failure-message" style="display: none;"></div>
<script>
var submitInputFlag;
var formSubmitCompleteSetTimeoutHandle;
var formUndoSetTimeoutHandle;
var failureMessageSetTimeoutHandle;
var lastFormSubmissionKey;
/**
 * Add some event listeners
 */
(function() {
  document.getElementById("submission-form").addEventListener("submit", function(event) {
    event.preventDefault();
  });
  document.getElementById("submit-input").addEventListener("click", function(event) {
    if (submitInputFlag)
      event.preventDefault();
  });
  Array.from(document.getElementsByClassName("stock-counter")).forEach(function(element) {
    element.addEventListener("invalid", function() {
      element.setCustomValidity("That's not how math works");
    });
  });
})();
/**
 * Deal with the form actually being submittted
 */
function formSubmitHandler(form) {
  if (formErrorCheck(form)) {
    return;
  } else {
    let formObject = Object.fromEntries((new FormData(form)).entries());
    formObject.industry = JSON.parse(formObject.territorySelect).industry;
    formObject.territory = JSON.parse(formObject.territorySelect).territory;
    delete formObject.territorySelect;
    formObject.stockCountStart = Number.parseInt(formObject.stockCountStart);
    formObject.stockCountEnd = Number.parseInt(formObject.stockCountEnd);
    formObject.winLose = formObject.winLose === "on";
    formObject.timestamp = Date.now();
    submitInputFlag = true;
    document.getElementById("submit-start-message").style = "display: block;";
    document.getElementById("undo-message").style = "display: none;";
    document.getElementById("submit-complete-message").style = "display: none;";
    // Replacement for google.script.run from the old version 
    fetch("/submit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(formObject)
    })
    .then(function(response) {
      return response.json();
    })
    .then(function(result) {
      lastFormSubmissionKey = result;
      submitInputFlag = false;
      form.reset();
      document.getElementById("submit-start-message").style = "display: none;";
      document.getElementById("submit-complete-message").style = "display: block;";
      clearTimeout(formSubmitCompleteSetTimeoutHandle);
      formSubmitCompleteSetTimeoutHandle = setTimeout(function() {
        document.getElementById("submit-complete-message").style = "display: none;";
      }, 15*1000);
    })
    .catch(function(error) {
      submitInputFlag = false;
      failureMessageHandler(error);
    });
  }
}
/**
 * Deal with the case where a mistake is made on form submission
 */
function formUndoHandler(){
  document.getElementById("submit-complete-message").style = "display: none;";
  fetch("/undo", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(lastFormSubmissionKey)
  })
  .then(function(response) {
    return response.json();
  })
  .then(function(result) {
    document.getElementById("gaffe-counter").innerText = result.gaffeCounter;
  })
  .catch(failureMessageHandler);
  document.getElementById("undo-message").style = "display: block;";
  clearTimeout(formUndoSetTimeoutHandle);
  formUndoSetTimeoutHandle = setTimeout(function() {
    document.getElementById("undo-message").style = "display: none;";
  }, 15*1000);
}
/**
 * Deal with server-side screw up
 */
function failureMessageHandler(error) {
  document.getElementById("submit-start-message").style = "display: none;";
  document.getElementById("submit-complete-message").style = "display: none;";
  document.getElementById("undo-message").style = "display: none;";
  document.getElementById("failure-message").innerHTML = error.toString();
  document.getElementById("failure-message").style = "display: block;";
  clearTimeout(failureMessageSetTimeoutHandle);
  failureMessageSetTimeoutHandle = setTimeout(function() {
    document.getElementById("failure-message").style = "display: none;";
  }, 60*1000);
}
/**
 * Client-side assurance of proper form submission
 * Can probably be thwarted by a malicious party, but whatever
 */
function formErrorCheck(form) {
  if (!document.getElementById("do-form-error-check").checked) {
    document.getElementById("form-error-check-message-area").style = "display: none;";
    document.getElementById("invalid-territory-select-message").style = "display: none;";
    document.getElementById("invalid-win-lose-message").style = "display: none;";
    document.getElementById("invalid-stock-count-start-message").style = "display: none;"
    document.getElementById("invalid-stock-count-end-message").style = "display: none;";
    return;
  }
  let formErrorRate = 0;
  // No character selected
  if (form.elements["territory-select"].selectedOptions[0].value === '{"territory": "none", "industry": "none"}') {
    document.getElementById("invalid-territory-select-message").style = "display: block;";
    ++formErrorRate;
  } else {
    document.getElementById("invalid-territory-select-message").style = "display: none;";
  }
  // Won with zero stocks left
  if (form.elements["win-lose"].checked && parseInt(form.elements["stock-count-end"].value) === 0) {
    document.getElementById("invalid-win-lose-message").style = "display: block;";
    ++formErrorRate;
  } else {
    document.getElementById("invalid-win-lose-message").style = "display: none;";
  }
  // Started with zero stocks
  if (parseInt(form.elements["stock-count-start"].value) === 0) {
    document.getElementById("invalid-stock-count-start-message").style = "display: block;";
    ++formErrorRate;
  } else {
    document.getElementById("invalid-stock-count-start-message").style = "display: none;";
  }
  // Ended with more stocks than started with
  if (parseInt(form.elements["stock-count-end"].value) > parseInt(form.elements["stock-count-start"].value)) {
    document.getElementById("invalid-stock-count-end-message").style = "display: block;";
    ++formErrorRate;
  } else {
    document.getElementById("invalid-stock-count-end-message").style = "display: none;";
  }
  // Display errors when applicable
  if (formErrorRate > 0){ 
    document.getElementById("form-error-check-message-area").style = "display: block;";
  } else {
    document.getElementById("form-error-check-message-area").style = "display: none;";
  }
  return (formErrorRate > 0);
}
</script>
</body>
</html>