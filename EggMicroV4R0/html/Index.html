<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="utf-8" />
  <title></title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
<style>
td, thead {
  border: 1px solid black;
}
td {
  width: 12ch;
  height: 1em;
}
/* tr:nth-child(even) {
  background-color: #eee;
} */
.Brown {
  background-color: peru;
}
.Black {
  background-color: lightslategrey;
}
.Cyan {
  background-color: lightcyan;
}
.Magenta {
  background-color: magenta;
}
.White {
  background-color: white;
}
.Orange {
  background-color: lightsalmon;
}
.Red {
  background-color: lightpink;
}
.Yellow {
  background-color: lightgoldenrodyellow;
}
.Green {
  background-color: lightgreen;
}
.Blue {
  background-color: lightskyblue;
}
</style>
</head>
<body>
<h1>EggMicroV4R0</h1>
<hr />
<div style="display: flex;">
  <div id="form-submission-main-area" style="width: 250px;">
    <form id="submission-form" onsubmit="formSubmitHandler(this)" method="POST">
      <div>
        <label for="territory-select">Territory</label>
        <select id="territory-select" name="territorySelect">
          <option value='{"territory": "none", "industry": "none"}' class="none" selected>
            ---
          </option>
          <option value='{"territory": "Alpha", "industry": "Brown"}' class="Brown">
            Alpha
          </option>
          <option value='{"territory": "Bravo", "industry": "Brown"}' class="Brown">
            Bravo
          </option>
          <option value='{"territory": "Charlie", "industry": "Black"}' class="Black">
            Charlie
          </option>
          <option value='{"territory": "Delta", "industry": "Cyan"}' class="Cyan">
            Delta
          </option>
          <option value='{"territory": "Echo", "industry": "Cyan"}' class="Cyan">
            Echo
          </option>
          <option value='{"territory": "Foxtrot", "industry": "Cyan"}' class="Cyan">
            Foxtrot
          </option>
          <option value='{"territory": "Golf", "industry": "Magenta"}' class="Magenta">
            Golf
          </option>
          <option value='{"territory": "Hotel", "industry": "White"}' class="White">
            Hotel
          </option>
          <option value='{"territory": "India", "industry": "Magenta"}' class="Magenta">
            India
          </option>
          <option value='{"territory": "Juliett", "industry": "Magenta"}' class="Magenta">
            Juliett
          </option>
          <option value='{"territory": "Kilo", "industry": "Black"}' class="Black">
            Kilo
          </option>
          <option value='{"territory": "Lima", "industry": "Orange"}' class="Orange">
            Lima
          </option>
          <option value='{"territory": "Mike", "industry": "Orange"}' class="Orange">
            Mike
          </option>
          <option value='{"territory": "November", "industry": "Orange"}' class="Orange">
            November
          </option>
          <option value='{"territory": "Oscar", "industry": "Red"}' class="Red">
            Oscar
          </option>
          <option value='{"territory": "Papa", "industry": "Red"}' class="Red">
            Papa
          </option>
          <option value='{"territory": "Quebec", "industry": "Red"}' class="Red">
            Quebec
          </option>
          <option value='{"territory": "Romeo", "industry": "Black"}' class="Black">
            Romeo
          </option>
          <option value='{"territory": "Sierra", "industry": "Yellow"}' class="Yellow">
            Sierra
          </option>
          <option value='{"territory": "Tango", "industry": "Yellow"}' class="Yellow">
            Tango
          </option>
          <option value='{"territory": "Uniform", "industry": "White"}' class="White">
            Uniform
          </option>
          <option value='{"territory": "Victor", "industry": "Yellow"}' class="Yellow">
            Victor
          </option>
          <option value='{"territory": "Whiskey", "industry": "Green"}' class="Green">
            Whiskey
          </option>
          <option value='{"territory": "X-ray", "industry": "Green"}' class="Green">
            X-ray
          </option>
          <option value='{"territory": "Yankee", "industry": "Green"}' class="Green">
            Yankee
          </option>
          <option value='{"territory": "Zulu", "industry": "Black"}' class="Black">
            Zulu
          </option>
          <option value='{"territory": "One", "industry": "Blue"}' class="Blue">
            Zero
          </option>
          <option value='{"territory": "One", "industry": "Blue"}' class="Blue">
            One
          </option>
        </select>
      </div>
      <div>
        <label for="win-lose">Won the match</label>
        <input id="win-lose" name="winLose" type="checkbox" />
      </div>
      <div>
        <label for="stock-count-start">Stock count start</label>
        <input id="stock-count-start" name="stockCountStart" type="number" min="0" max="10" value="0" />
      </div>
      <div>
        <label for="stock-count-end">Stock count end</label>
        <input id="stock-count-end" name="stockCountEnd" type="number" min="0" max="10" value="0" />
      </div>
      <div>
        <input id="submit-input" type="submit" value="Plug it in, coach" />
      </div>
    </form>
    <!-- <input id="do-form-error-check" type="checkbox" checked />
    <label for="do-form-error-check">Error check</label> -->
  </div>
  <div id="form-submission-message-area">
    <div id="submit-start-message" style="display: none;">
      Form submitted, please wait...
    </div>
    <div id="submit-complete-message" style="display: none;">
      Your taxes have been filed
      <br />
      <input type="button" onclick="formUndoHandler()" value="Undo" />
    </div>
    <div id="undo-message" style="display: none;">
      Don't mess it up this time, pal
      <br />
      Gaffe counter: <span id="gaffe-counter"></span>
    </div>
    <div id="form-error-check-message-area" style="display: none;">
      <div id="invalid-territory-select-message" style="display: none;">
        Pick a territory bruh
      </div>
      <div id="invalid-win-lose-message" style="display: none;">
        "Yes officer I won the game with zero stocks left I swear"
      </div>
      <div id="invalid-stock-count-start-message" style="display: none;">
        If you started with zero stocks that means you were dead #wakemeupinside
      </div>
      <div id="invalid-stock-count-end-message" style="display: none;">
        You can't end up with more stocks than you started with. That's called theft and it's very illegal.
      </div>
    </div>
    <div id="failure-message" style="display: none;"></div>
  </div></div>
<hr />
<table id="stock-price-table" style="border-collapse: collapse;">
  <thead>
    <tr>
      <th colspan="2">Stock prices</th>
      <th colspan="2">
        <input type="button" onclick="getStockPriceHandler()" value="Get the latest" />
      </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="Brown">Alpha</td>
      <td class="Brown" id="stock-price-alpha"></td>
      <td class="Red">Oscar</td>
      <td class="Red" id="stock-price-oscar"></td>
    </tr>
    <tr>
      <td class="Brown">Bravo</td>
      <td class="Brown" id="stock-price-bravo"></td>
      <td class="Red">Papa</td>
      <td class="Red" id="stock-price-papa"></td>
    </tr>
    <tr>
      <td class="Black">Charlie</td>
      <td class="Black" id="stock-price-charlie"></td>
      <td class="Red">Quebec</td>
      <td class="Red" id="stock-price-quebec"></td>
    </tr>
    <tr>
      <td class="Cyan">Delta</td>
      <td class="Cyan" id="stock-price-delta"></td>
      <td class="Black">Romeo</td>
      <td class="Black" id="stock-price-romeo"></td>
    </tr>
    <tr>
      <td class="Cyan">Echo</td>
      <td class="Cyan" id="stock-price-echo"></td>
      <td class="Yellow">Sierra</td>
      <td class="Yellow" id="stock-price-sierra"></td>
    </tr>
    <tr>
      <td class="Cyan">Foxtrot</td>
      <td class="Cyan" id="stock-price-foxtrot"></td>
      <td class="Yellow">Tango</td>
      <td class="Yellow" id="stock-price-tango"></td>
    </tr>
    <tr>
      <td class="Magenta">Golf</td>
      <td class="Magenta" id="stock-price-golf"></td>
      <td class="White">Uniform</td>
      <td class="White" id="stock-price-uniform"></td>
    </tr>
    <tr>
      <td class="White">Hotel</td>
      <td class="White" id="stock-price-hotel"></td>
      <td class="Yellow">Victor</td>
      <td class="Yellow" id="stock-price-victor"></td>
    </tr>
    <tr>
      <td class="Magenta">India</td>
      <td class="Magenta" id="stock-price-india"></td>
      <td class="Green">Whiskey</td>
      <td class="Green" id="stock-price-whiskey"></td>
    </tr>
    <tr>
      <td class="Magenta">Juliett</td>
      <td class="Magenta" id="stock-price-juliett"></td>
      <td class="Green">X-ray</td>
      <td class="Green" id="stock-price-x-ray"></td>
    </tr>
    <tr>
      <td class="Black">Kilo</td>
      <td class="Black" id="stock-price-kilo"></td>
      <td class="Green">Yankee</td>
      <td class="Green" id="stock-price-yankee"></td>
    </tr>
    <tr>
      <td class="Orange">Lima</td>
      <td class="Orange" id="stock-price-lima"></td>
      <td class="Black">Zulu</td>
      <td class="Black" id="stock-price-zulu"></td>
    </tr>
    <tr>
      <td class="Orange">Mike</td>
      <td class="Orange" id="stock-price-mike"></td>
      <td class="Blue">Zero</td>
      <td class="Blue" id="stock-price-zero"></td>
    </tr>
    <tr>
      <td class="Orange">November</td>
      <td class="Orange" id="stock-price-november"></td>
      <td class="Blue">One</td>
      <td class="Blue" id="stock-price-one"></td>
    </tr>
  </tbody>
</table>
<script>
/** @type {boolean} */
var submitInputFlag;
/** @type {string} */
var lastFormSubmissionKey;
/** @type {number} */
var formSubmitCompleteSetTimeoutHandle;
/** @type {number} */
var formUndoSetTimeoutHandle;
/** @type {number} */
var failureMessageSetTimeoutHandle;
/**
 * Add some event listeners
 */
(function() {
  document.getElementById("submission-form").addEventListener("submit", function(event) {
    event.preventDefault();
  });
  document.getElementById("submit-input").addEventListener("click", function(event) {
    if (submitInputFlag)
      event.preventDefault();
  });
})();
/**
 * Deal with the form actually being submittted
 * @param {HTMLFormElement} form The submission form object
 */
function formSubmitHandler(form) {
  document.getElementById("failure-message").style = "display: none;"
  if (formErrorCheck(form))
    return;
  const formObject = Object.fromEntries((new FormData(form)).entries());
  formObject.industry = JSON.parse(formObject.territorySelect).industry;
  formObject.territory = JSON.parse(formObject.territorySelect).territory;
  delete formObject.territorySelect;
  formObject.stockCountStart = Number.parseInt(formObject.stockCountStart);
  formObject.stockCountEnd = Number.parseInt(formObject.stockCountEnd);
  formObject.winLose = formObject.winLose === "on";
  formObject.timestamp = Date.now();
  formObject.extraData = {};
  submitInputFlag = true;
  document.getElementById("submit-start-message").style = "display: block;";
  document.getElementById("undo-message").style = "display: none;";
  document.getElementById("submit-complete-message").style = "display: none;";
  // Replacement for google.script.run() from EggScriptV8 
  fetch("/submit", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(formObject)
  })
  .then(validateResponse)
  .then(function(result) {
    lastFormSubmissionKey = result;
    form.reset();
    document.getElementById("submit-start-message").style = "display: none;";
    document.getElementById("submit-complete-message").style = "display: block;";
    clearTimeout(formSubmitCompleteSetTimeoutHandle);
    formSubmitCompleteSetTimeoutHandle = setTimeout(function() {
      document.getElementById("submit-complete-message").style = "display: none;";
    }, 15*1000);
  })
  .catch(failureMessageHandler)
  .finally(function() {
    submitInputFlag = false;
  });
}
/**
 * Deal with the case where a mistake is made on form submission
 */
function formUndoHandler(){
  document.getElementById("submit-complete-message").style = "display: none;";
  fetch("/undo", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(lastFormSubmissionKey)
  })
  .then(validateResponse)
  .then(function(result) {
    document.getElementById("gaffe-counter").innerText = result.gaffeCounter;
  })
  .catch(failureMessageHandler)
  .finally(function() {
    document.getElementById("undo-message").style = "display: block;";
    clearTimeout(formUndoSetTimeoutHandle);
    formUndoSetTimeoutHandle = setTimeout(function() {
      document.getElementById("undo-message").style = "display: none;";
    }, 15*1000);
  });
}
/**
 * Retrieve new values for the stock price table
 */
function getStockPriceHandler() {
  fetch("/stock-prices", {
    method: "GET"
  })
  .then(validateResponse)
  .then(function(result) {
    for (const property in result) {
      document.getElementById(`stock-price-${property.toLowerCase()}`).innerText = result[property];
    }
  })
  .catch(failureMessageHandler);
}
/**
 * Make sure that the response is ok
 * @param {Response} response Get this from any fetch()
 * @returns {Promise<any>} Object on success, error message on failure
 */
async function validateResponse(response) {
  return response.ok ? response.json() :
    Promise.reject(`${response.status} ${response.statusText}\n${await response.text()}`);
}
/**
 * Deal with server-side screw up
 * @param {Error} error Any error that may have been raised during the submission process
 */
function failureMessageHandler(error) {
  document.getElementById("submit-start-message").style = "display: none;";
  document.getElementById("submit-complete-message").style = "display: none;";
  document.getElementById("undo-message").style = "display: none;";
  document.getElementById("failure-message").innerHTML = error.toString();
  document.getElementById("failure-message").style = "display: block;";
  clearTimeout(failureMessageSetTimeoutHandle);
  failureMessageSetTimeoutHandle = setTimeout(function() {
    document.getElementById("failure-message").style = "display: none;";
  }, 120*1000);
}
/**
 * Client-side assurance of proper form submission
 * Can probably be thwarted by a malicious party, but whatever
 * @param {HTMLFormElement} form The submitted form
 * @returns {boolean} Whether or not the form has errors in it
 */
function formErrorCheck(form) {
  /* if (!document.getElementById("do-form-error-check").checked) {
    document.getElementById("form-error-check-message-area").style = "display: none;";
    document.getElementById("invalid-territory-select-message").style = "display: none;";
    document.getElementById("invalid-win-lose-message").style = "display: none;";
    document.getElementById("invalid-stock-count-start-message").style = "display: none;"
    document.getElementById("invalid-stock-count-end-message").style = "display: none;";
    return false;
  } */
  let formErrorRate = 0;
  // No character selected
  if (form.elements["territory-select"].selectedOptions[0].value === '{"territory": "none", "industry": "none"}') {
    document.getElementById("invalid-territory-select-message").style = "display: block;";
    ++formErrorRate;
  } else {
    document.getElementById("invalid-territory-select-message").style = "display: none;";
  }
  // Won with zero stocks left
  if (form.elements["win-lose"].checked && parseInt(form.elements["stock-count-end"].value) === 0) {
    document.getElementById("invalid-win-lose-message").style = "display: block;";
    ++formErrorRate;
  } else {
    document.getElementById("invalid-win-lose-message").style = "display: none;";
  }
  // Started with zero stocks
  if (parseInt(form.elements["stock-count-start"].value) === 0) {
    document.getElementById("invalid-stock-count-start-message").style = "display: block;";
    ++formErrorRate;
  } else {
    document.getElementById("invalid-stock-count-start-message").style = "display: none;";
  }
  // Ended with more stocks than started with
  if (parseInt(form.elements["stock-count-end"].value) > parseInt(form.elements["stock-count-start"].value)) {
    document.getElementById("invalid-stock-count-end-message").style = "display: block;";
    ++formErrorRate;
  } else {
    document.getElementById("invalid-stock-count-end-message").style = "display: none;";
  }
  // Display errors when applicable
  if (formErrorRate > 0) { 
    document.getElementById("form-error-check-message-area").style = "display: block;";
  } else {
    document.getElementById("form-error-check-message-area").style = "display: none;";
  }
  return (formErrorRate > 0);
}
</script>
</body>
</html>